id: Uncommon creation or access operation of sensitive shadow copy by a high-risk process
version: -1
name: Uncommon creation or access operation of sensitive shadow copy by a high-risk process
description: "This playbook addresses the following alerts:\n \n- Uncommon creation or access operation of sensitive shadow copy by a high-risk process\n \nPlaybook Stages:\n  \nTriage: \n \n- Check if the causality process image (CGO) is signed or not\n \nInvestigation:\n \n- If CGO is unsigned:\n  - Check the CGO process prevalence\n  - Check if the process image path is common\n- If CGO is signed:\n  - Check process image name\n  - Check initiating process image name\n  - Check if username is SYSTEM\n  - Check if host is a server\n  - Check for previous similar alert closed as False Positive\n \nContainment:\n \n- Terminate causality process (CGO) process - when a signed high-risk process or an unsigned process from an uncommon path attempting to create or access sensitive shadow copy data."
tags:
- T1003 - OS Credential Dumping
- TA0006 - Credential Access
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 428b5718-7175-42a6-8bef-53a30125d97c
    type: start
    task:
      id: 428b5718-7175-42a6-8bef-53a30125d97c
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "31"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 705,
          "y": -385
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: c6089b52-e788-4593-8d95-00223f919652
    type: condition
    task:
      id: c6089b52-e788-4593-8d95-00223f919652
      version: -1
      name: Check if CGO is signed
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "17"
      CGO-Signed:
      - "33"
    separatecontext: false
    conditions:
    - label: CGO-Signed
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.osparentsignature
            iscontext: true
          right:
            value:
              simple: SIGNATURE_SIGNED
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 705,
          "y": -105
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: f0154772-d5ec-42cc-8053-0cf4f57da493
    type: condition
    task:
      id: f0154772-d5ec-42cc-8053-0cf4f57da493
      version: -1
      name: Check CGO image name
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "13"
      cmd.exe|rundll32.exe:
      - "10"
      powershell.exe:
      - "9"
    separatecontext: false
    conditions:
    - label: powershell.exe
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: powershell.exe
          ignorecase: true
    - label: cmd.exe|rundll32.exe
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: cmd.exe
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: rundll32.exe
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 110,
          "y": 210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: 3538379b-1a77-4f01-8688-2fe1caa4c8ec
    type: condition
    task:
      id: 3538379b-1a77-4f01-8688-2fe1caa4c8ec
      version: -1
      name: Check actor_process_image_name
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "10"
      (powershell.exe | ntdsutil.exe | esentutl.exe | cmd.exe:
      - "11"
    separatecontext: false
    conditions:
    - label: (powershell.exe | ntdsutil.exe | esentutl.exe | cmd.exe
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.initiatedby
            iscontext: true
          right:
            value:
              simple: powershell.exe
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.initiatedby
            iscontext: true
          right:
            value:
              simple: cmd.exe
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.initiatedby
            iscontext: true
          right:
            value:
              simple: esentutl.exe
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.initiatedby
            iscontext: true
          right:
            value:
              simple: ntdsutil.exe
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -210,
          "y": 385
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: cc7e9e61-7560-48b8-8ca4-cab430695e9e
    type: condition
    task:
      id: cc7e9e61-7560-48b8-8ca4-cab430695e9e
      version: -1
      name: Check actor_process_image_name VSSVC.exe & username SYSTEM
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "12"
      "yes":
      - "11"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.initiatedby
            iscontext: true
          right:
            value:
              simple: VSSVC.exe
          ignorecase: true
      - - operator: containsString
          left:
            value:
              simple: alert.username
            iscontext: true
          right:
            value:
              simple: SYSTEM
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 110,
          "y": 555
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: 91d336ec-f65c-49d8-8478-2db259fda538
    type: title
    task:
      id: 91d336ec-f65c-49d8-8478-2db259fda538
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "26"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 110,
          "y": 1100
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 8dfc4320-e1fd-43ce-8c00-2603050d46c8
    type: title
    task:
      id: 8dfc4320-e1fd-43ce-8c00-2603050d46c8
      version: -1
      name: Inconclusive
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 915,
          "y": 1090
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: e2b5323d-2924-4bf6-8439-041c85b45852
    type: condition
    task:
      id: e2b5323d-2924-4bf6-8439-041c85b45852
      version: -1
      name: Check CGO image name is mmc.exe & OS is server
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "15"
      "yes":
      - "14"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: mmc.exe
          ignorecase: true
      - - operator: containsString
          left:
            value:
              simple: alert.agentossubtype
            iscontext: true
          right:
            value:
              simple: Server
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 512.5,
          "y": 385
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: da277d21-3e93-4c1c-8ee9-7154a9ce95a3
    type: title
    task:
      id: da277d21-3e93-4c1c-8ee9-7154a9ce95a3
      version: -1
      name: Common False Positive behavior
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 512.5,
          "y": 1090
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 6caefd22-63e0-4214-8338-c82a251bf75d
    type: title
    task:
      id: 6caefd22-63e0-4214-8338-c82a251bf75d
      version: -1
      name: Inconclusive
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "29"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 915,
          "y": 555
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: cd2d9a39-7e2d-4c76-8ee1-c21683bdc9c5
    type: title
    task:
      id: cd2d9a39-7e2d-4c76-8ee1-c21683bdc9c5
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "11"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1330,
          "y": 860
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 62314706-1001-4f0d-85cd-31f8a5e87266
    type: title
    task:
      id: 62314706-1001-4f0d-85cd-31f8a5e87266
      version: -1
      name: Investigation
      description: Get the prevalence of a process, identified by process_name.
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "32"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1330,
          "y": 70
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: bf2b6360-6501-409f-88c5-93623524e48c
    type: regular
    task:
      id: bf2b6360-6501-409f-88c5-93623524e48c
      version: -1
      name: Close Alert - False Positive
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "19"
    scriptarguments:
      closeNotes:
        simple: Found common false positive behavior or previous similar alerts closed as False Positive.
      closeReason:
        simple: Resolved - Handled by the playbook "Uncommon creation or access operation of sensitive shadow copy by a high-risk process"
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 512.5,
          "y": 1230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: 8b07b7af-d903-41ac-895e-8bd498bc4288
    type: title
    task:
      id: 8b07b7af-d903-41ac-895e-8bd498bc4288
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 512.5,
          "y": 1750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 92e9595e-122b-4c9b-8190-44e377c737d9
    type: regular
    task:
      id: 92e9595e-122b-4c9b-8190-44e377c737d9
      version: -1
      name: Close Alert - True Positive
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "19"
    scriptarguments:
      closeNotes:
        simple: Malicious Process attempted to create or access ShadowCopy
      closeReason:
        simple: Resolved - Handled by the playbook "Suspicious access to shadow file"
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 110,
          "y": 1580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: e1ce75c2-ed9d-4709-8878-1f305495eccc
    type: regular
    task:
      id: e1ce75c2-ed9d-4709-8878-1f305495eccc
      version: -1
      name: Terminate Causality (CGO)
      description: Terminate a process tree by its causality ID. Available only for Cortex XSIAM 2.4.
      script: '|||core-terminate-causality'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "27"
      '#none#':
      - "24"
    scriptarguments:
      agent_id:
        simple: ${alert.agentid}
      causality_id:
        simple: ${alert.cid}
      timeout_in_seconds:
        simple: "180"
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": 107.5,
          "y": 1230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: 4a8f2186-267b-46bd-8abe-ad82434463a2
    type: regular
    task:
      id: 4a8f2186-267b-46bd-8abe-ad82434463a2
      version: -1
      name: Terminate Causality Process Manually
      description: |
        Dear Analyst,

        During the remediation process, the playbook failed to terminate the causality process: ${alert.cgoname}
        Please investigate this before closing this alert.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "24"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -110,
          "y": 1410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: ed439778-6001-42b4-8be1-05769f1a1122
    type: condition
    task:
      id: ed439778-6001-42b4-8be1-05769f1a1122
      version: -1
      name: Check if process path is common & causality process is prevalent
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "15"
      Uncommon-Path:
      - "16"
    separatecontext: false
    conditions:
    - label: Uncommon-Path
      condition:
      - - operator: notContainsString
          left:
            value:
              simple: alert.initiatorpath
            iscontext: true
          right:
            value:
              simple: C:\Program Files
          ignorecase: true
      - - operator: notContainsString
          left:
            value:
              simple: alert.initiatorpath
            iscontext: true
          right:
            value:
              simple: C:\Windows
          ignorecase: true
      - - operator: isEqualString
          left:
            value:
              simple: Core.AnalyticsPrevalence.Process.value
            iscontext: true
          right:
            value:
              simple: "False"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1330,
          "y": 385
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 567766c6-1d5a-4503-8d90-381bc56f626a
    type: regular
    task:
      id: 567766c6-1d5a-4503-8d90-381bc56f626a
      version: -1
      name: Check if Previous Similar Alerts
      description: |
        Finds past similar alerts based on alert fields' similarity.
      scriptName: SearchIncidentsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "30"
    scriptarguments:
      fromdate:
        simple: 30 days ago
      name:
        simple: ${alert.name}
      query:
        simple: name:"Uncommon creation or access operation of sensitive shadow copy by a high-risk process" and resolution_status:*False*Positive*
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 915,
          "y": 685
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: 2c5471f8-5841-4359-8960-f2273ec3cbff
    type: condition
    task:
      id: 2c5471f8-5841-4359-8960-f2273ec3cbff
      version: -1
      name: Check if Previous Alerts Closed as False Positive
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "12"
      "yes":
      - "14"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: foundIncidents
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 915,
          "y": 845
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: a5c00bd3-eda3-4a80-8db7-160828d6bc8b
    type: title
    task:
      id: a5c00bd3-eda3-4a80-8db7-160828d6bc8b
      version: -1
      name: Triage
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "6"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 705,
          "y": -240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: 84fdb0e0-163f-4ecf-8545-b41727f8c970
    type: regular
    task:
      id: 84fdb0e0-163f-4ecf-8545-b41727f8c970
      version: -1
      name: Get Causality process prevalence
      description: Get the prevalence of a process, identified by process_name.
      script: '|||core-get-process-analytics-prevalence'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "28"
    scriptarguments:
      process_name:
        simple: ${alert.cgoname}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1330,
          "y": 210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: db0e4684-aeb5-4d83-8279-e9ab7dcd5da7
    type: title
    task:
      id: db0e4684-aeb5-4d83-8279-e9ab7dcd5da7
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "7"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 110,
          "y": 70
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "10_11_yes": 0.38,
      "10_12_#default#": 0.4,
      "26_27_#error#": 0.57,
      "30_12_#default#": 0.33,
      "7_10_cmd.exe|rundll32.exe": 0.42,
      "7_13_#default#": 0.51,
      "7_9_powershell.exe": 0.65,
      "9_11_(powershell.exe | ntdsutil.exe | esentutl.exe | cmd.exe": 0.34
    },
    "paper": {
      "dimensions": {
        "height": 2200,
        "width": 1920,
        "x": -210,
        "y": -385
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.10.0
