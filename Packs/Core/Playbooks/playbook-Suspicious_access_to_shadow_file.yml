id: Suspicious access to shadow file
version: -1
name: Suspicious access to shadow file
description: "This playbook addresses the following alerts:\n \n- Uncommon creation or access operation of sensitive shadow copy by a high-risk process\n- Suspicious access to shadow file\n \nPlaybook Stages:\n  \nTriage: \n \n- Verify if the Causality Generating Object (CGO) is signed and analyze its image name\n \nInvestigation:\n \n- Examine process details, prevalence, and historical data for similar alerts\n \nContainment:\n \n- Terminate suspicious processes"

tags:
- T1003 - OS Credential Dumping
- TA0006 - Credential Access
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 2b1843da-b454-40d0-8c98-d43d5aac61c7
    type: start
    task:
      id: 2b1843da-b454-40d0-8c98-d43d5aac61c7
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "6"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 705,
          "y": -115
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 45cabc54-42bf-4b00-8b00-f061a71985df
    type: condition
    task:
      id: 45cabc54-42bf-4b00-8b00-f061a71985df
      version: -1
      name: Check if CGO is signed
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "17"
      CGO-Signed:
      - "7"
    separatecontext: false
    conditions:
    - label: CGO-Signed
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.osparentsignature.[0]
            iscontext: true
          right:
            value:
              simple: SIGNATURE_SIGNED
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 705,
          "y": 25
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: 2667e8b6-1a0c-4371-830f-cbcc85cefe0e
    type: condition
    task:
      id: 2667e8b6-1a0c-4371-830f-cbcc85cefe0e
      version: -1
      name: Check CGO image name
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "13"
      cmd.exe|rundll32.exe:
      - "10"
      powershell.exe:
      - "9"
    separatecontext: false
    conditions:
    - label: powershell.exe
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: powershell.exe
          ignorecase: true
    - label: cmd.exe|rundll32.exe
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: cmd.exe
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: rundll32.exe
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 107.5,
          "y": 200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: 20bb089a-85d7-460d-8132-f6e8896f84e4
    type: condition
    task:
      id: 20bb089a-85d7-460d-8132-f6e8896f84e4
      version: -1
      name: Check actor_process_image_name
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "10"
      (powershell.exe | ntdsutil.exe | esentutl.exe | cmd.exe:
      - "11"
    separatecontext: false
    conditions:
    - label: (powershell.exe | ntdsutil.exe | esentutl.exe | cmd.exe
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.initiatedby
            iscontext: true
          right:
            value:
              simple: powershell.exe
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.initiatedby
            iscontext: true
          right:
            value:
              simple: cmd.exe
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.initiatedby
            iscontext: true
          right:
            value:
              simple: esentutl.exe
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.initiatedby
            iscontext: true
          right:
            value:
              simple: ntdsutil.exe
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -210,
          "y": 385
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: eb0f834d-c611-4168-83b1-2810a762d561
    type: condition
    task:
      id: eb0f834d-c611-4168-83b1-2810a762d561
      version: -1
      name: Check actor_process_image_name VSSVC.exe & username SYSTEM
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "12"
      "yes":
      - "11"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.initiatedby
            iscontext: true
          right:
            value:
              simple: VSSVC.exe
          ignorecase: true
      - - operator: containsString
          left:
            value:
              simple: alert.username.[0]
            iscontext: true
          right:
            value:
              simple: SYSTEM
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 110,
          "y": 555
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: 9598e1e5-8f95-43fd-8378-1afd9a0a4964
    type: title
    task:
      id: 9598e1e5-8f95-43fd-8378-1afd9a0a4964
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "26"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 107.5,
          "y": 1100
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: ee5bea53-5707-4ba5-80d0-154f7734eab3
    type: title
    task:
      id: ee5bea53-5707-4ba5-80d0-154f7734eab3
      version: -1
      name: No Verdict
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 930,
          "y": 1100
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: da20cac0-b1f5-4556-809b-649bc1f783ed
    type: condition
    task:
      id: da20cac0-b1f5-4556-809b-649bc1f783ed
      version: -1
      name: Check CGO image name is mmc.exe & OS is server
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "15"
      "yes":
      - "14"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: ${alert.cgoname}
            iscontext: true
          right:
            value:
              simple: mmc.exe
          ignorecase: true
      - - operator: containsString
          left:
            value:
              simple: alert.agentossubtype
            iscontext: true
          right:
            value:
              simple: Server
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 512.5,
          "y": 385
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 399768de-2567-4ae5-879e-a373d4e4903c
    type: title
    task:
      id: 399768de-2567-4ae5-879e-a373d4e4903c
      version: -1
      name: Common FP behaviour - No Results Found
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 512.5,
          "y": 1090
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 891a7f17-7fc8-4ecb-88a1-4a4d65561bb6
    type: title
    task:
      id: 891a7f17-7fc8-4ecb-88a1-4a4d65561bb6
      version: -1
      name: No Verdict
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "29"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 915,
          "y": 555
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: 6c47a73d-1a8e-4882-8590-245fffde9704
    type: title
    task:
      id: 6c47a73d-1a8e-4882-8590-245fffde9704
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "11"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1330,
          "y": 860
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 878cf460-bb34-4cb1-8e3b-11fed639d400
    type: regular
    task:
      id: 878cf460-bb34-4cb1-8e3b-11fed639d400
      version: -1
      name: Get Causality process prevalence
      description: Get the prevalence of a process, identified by process_name.
      script: '|||core-get-process-analytics-prevalence'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "28"
    scriptarguments:
      process_name:
        simple: ${alert.cgoname}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1330,
          "y": 200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 8af1f43f-ca51-4bbe-81e5-5a557ac1cdda
    type: regular
    task:
      id: 8af1f43f-ca51-4bbe-81e5-5a557ac1cdda
      version: -1
      name: Close Alert - FP
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "19"
    scriptarguments:
      closeNotes:
        simple: No Malicious Results Found
      closeReason:
        simple: Resolved - Handled by the playbook "Suspicious access to shadow file"
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 512.5,
          "y": 1230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: 1a6b1eb5-ae5d-4da9-8d52-fdb4c214042a
    type: title
    task:
      id: 1a6b1eb5-ae5d-4da9-8d52-fdb4c214042a
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 512.5,
          "y": 1750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 074b7958-e0c6-4d30-8646-dbb2e0485906
    type: regular
    task:
      id: 074b7958-e0c6-4d30-8646-dbb2e0485906
      version: -1
      name: Close Alert - True Positive
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "19"
    scriptarguments:
      closeNotes:
        simple: Malicious Process attempted to create or access ShadowCopy
      closeReason:
        simple: Resolved - Handled by the playbook "Suspicious access to shadow file"
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 110,
          "y": 1580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: 00476411-2779-4c70-844f-5d4cb2503d6d
    type: regular
    task:
      id: 00476411-2779-4c70-844f-5d4cb2503d6d
      version: -1
      name: Terminate Causality (CGO)
      description: Terminate a process tree by its causality ID. Available only for Cortex XSIAM 2.4.
      script: '|||core-terminate-causality'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "27"
      '#none#':
      - "24"
    scriptarguments:
      agent_id:
        simple: ${alert.agentid}
      causality_id:
        simple: ${alert.cid}
      timeout_in_seconds:
        simple: "180"
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": 107.5,
          "y": 1230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: 9256a97d-0cc3-48de-8af8-7829f2aecde9
    type: regular
    task:
      id: 9256a97d-0cc3-48de-8af8-7829f2aecde9
      version: -1
      name: Terminate Causality Process Manually
      description: |
        Dear Analyst,

        During the remediation process, the playbook failed to terminate the causality process: ${alert.cgoname}
        Please investigate this before closing this alert.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "24"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -110,
          "y": 1410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: 03e3f109-a454-49d5-89a2-c0271b49552d
    type: condition
    task:
      id: 03e3f109-a454-49d5-89a2-c0271b49552d
      version: -1
      name: Check if process path is common & causality process is prevalent
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "15"
      Uncommon-Path:
      - "16"
    separatecontext: false
    conditions:
    - label: Uncommon-Path
      condition:
      - - operator: notContainsString
          left:
            value:
              simple: alert.initiatorpath.[0]
            iscontext: true
          right:
            value:
              simple: C:\Program Files
          ignorecase: true
      - - operator: notContainsString
          left:
            value:
              simple: alert.initiatorpath.[0]
            iscontext: true
          right:
            value:
              simple: C:\Windows
          ignorecase: true
      - - operator: isEqualString
          left:
            value:
              simple: Core.AnalyticsPrevalence.Process.value
            iscontext: true
          right:
            value:
              simple: "False"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1330,
          "y": 385
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: b0ffeab0-a316-4ad5-8d50-5d6b95a86cdf
    type: regular
    task:
      id: b0ffeab0-a316-4ad5-8d50-5d6b95a86cdf
      version: -1
      name: Check if Previous Similar Alerts
      description: |
        Finds past similar alerts based on alert fields' similarity.
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "30"
    scriptarguments:
      fromdate:
        simple: 3 months ago
      name:
        simple: ${alert.name}
      query:
        simple: 'resolution_status: STATUS_060_RESOLVED_FALSE_POSITIVE and hostname: ${alert.hostname}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 915,
          "y": 685
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: 68b415b6-b846-412c-86f7-b71f265470cf
    type: condition
    task:
      id: 68b415b6-b846-412c-86f7-b71f265470cf
      version: -1
      name: Check if Previous Alerts Closed as FP
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "12"
      "yes":
      - "14"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: foundIncidents
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 915,
          "y": 845
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "10_11_yes": 0.38,
      "10_12_#default#": 0.4,
      "26_27_#error#": 0.57,
      "30_12_#default#": 0.33,
      "7_10_cmd.exe|rundll32.exe": 0.42,
      "7_13_#default#": 0.51,
      "7_9_powershell.exe": 0.65,
      "9_11_(powershell.exe | ntdsutil.exe | esentutl.exe | cmd.exe": 0.34
    },
    "paper": {
      "dimensions": {
        "height": 1930,
        "width": 1920,
        "x": -210,
        "y": -115
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.10.0
